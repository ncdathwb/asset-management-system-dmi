{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Hidden CSRF token field for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>資産管理</h2>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAssetModal">
                <i class="fas fa-plus"></i> 資産を追加
            </button>
        </div>
    </div>

    <!-- Search and Filter Toolbar -->
    <div class="asset-toolbar d-flex flex-wrap align-items-center gap-2 mb-4 mt-3">
        <input type="text" class="form-control" id="searchInput" placeholder="コードまたは名前で検索..." style="max-width: 220px;">
        <select class="form-select" id="typeFilter" style="max-width: 180px;">
            <option value="">すべてのタイプ</option>
            {% for type in asset_types %}
            <option value="{{ type.name }}">{{ type.jp }}</option>
            {% endfor %}
        </select>
        <select class="form-select" id="statusFilter" style="max-width: 220px;">
            <option value="">すべてのステータス</option>
            <option value="Available">利用可能</option>
            <option value="In Use">使用中</option>
            <option value="Under maintenance">メンテナンス中</option>
            <option value="Damaged">損傷</option>
            <option value="Lost">紛失</option>
        </select>
        <button class="btn btn-secondary" onclick="exportToCSV()">
            <i class="fas fa-download"></i> CSVにエクスポート
        </button>
    </div>

    <!-- Assets Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>資産コード</th>
                            <th>名前</th>
                            <th>タイプ</th>
                            <th>総数量</th>
                            <th>利用可能</th>
                            <th>割り当て済み</th>
                            <th>ステータス</th>
                            <th>アクション</th>
                        </tr>
                    </thead>
                    <tbody id="assetTableBody">
                        {# Asset data will be loaded here by JavaScript #}
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <!-- Removed bulk reclaim button -->
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center mt-4">
                {# Pagination links will be generated by JavaScript #}
                <div id="paginationLinks"></div>
            </div>
        </div>
    </div>
</div>

<!-- Add Asset Modal -->
<div class="modal fade" id="addAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新しい資産を追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assetForm" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="mb-3">
                        <label class="form-label">資産コード</label>
                        <input type="text" class="form-control" name="asset_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">資産名</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">資産タイプ</label>
                        <select class="form-select" name="type" required>
                            {% for type in asset_types %}
                            <option value="{{ type.name }}">{{ type.jp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">数量</label>
                        <input type="number" class="form-control" name="quantity" min="1" value="1" required>
                        <div class="form-text">最小数量は1です</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ステータス</label>
                        <select class="form-select" name="status" required>
                            <option value="Available" selected>利用可能</option>
                            <option value="In Use">使用中</option>
                            <option value="Under maintenance">メンテナンス中</option>
                            <option value="Damaged">損傷</option>
                            <option value="Lost">紛失</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">画像</label>
                        <input type="file" class="form-control" name="image" id="assetImage" accept="image/*">
                        <div class="form-text">JPG, PNG, GIF形式の画像をアップロードできます（最大2MB）</div>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img src="" alt="プレビュー" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitAssetForm()">資産を追加</button>
            </div>
        </div>
    </div>
</div>

<!-- Asset Details Modal -->
<div class="modal fade" id="assetDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">資産の詳細</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="assetDetailsLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                    <p class="mt-2">資産の詳細を読み込んでいます...</p>
                </div>
                <div id="assetDetailsContent" class="d-none">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>資産の情報</h5>
                            <table class="table table-bordered">
                                <tr>
                                    <th>資産コード</th>
                                    <td id="detail-asset-code"></td>
                                </tr>
                                <tr>
                                    <th>名前</th>
                                    <td id="detail-name"></td>
                                </tr>
                                <tr>
                                    <th>タイプ</th>
                                    <td id="detail-type"></td>
                                </tr>
                                <tr>
                                    <th>総数量</th>
                                    <td id="detail-quantity"></td>
                                </tr>
                                <tr>
                                    <th>利用可能</th>
                                    <td id="detail-available"></td>
                                </tr>
                                <tr>
                                    <th>ステータス</th>
                                    <td id="detail-status"></td>
                                </tr>
                                <tr>
                                    <th>ブランチ</th>
                                    <td id="detail-branch"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">画像</h5>
                                </div>
                                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                                    <div id="assetImagePreview" class="mb-3" style="width: 180px; height: 180px; background: #f5f5f5; border: 1px solid #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <span style="color: #bbb;">画像がありません</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h5>割り当て先</h5>
                            <div id="noAssignmentsMsg" class="alert alert-info d-none">
                                この資産は現在割り当てられていません。
                            </div>
                            <table class="table table-striped" id="assignmentsTable">
                                <thead>
                                    <tr>
                                        <th>従業員コード</th>
                                        <th>名前</th>
                                        <th>部署</th>
                                        <th>メール</th>
                                        <th>ブランチ</th>
                                        <th>アクション</th>
                                    </tr>
                                </thead>
                                <tbody id="assignmentsTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Asset Modal -->
<div class="modal fade" id="editAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">資産を編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="editAssetLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                    <p class="mt-2">資産の情報を読み込んでいます...</p>
                </div>
                <form id="editAssetForm" class="d-none">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="asset_id" id="edit_asset_id">
                    <div class="mb-3">
                        <label class="form-label">資産コード</label>
                        <input type="text" class="form-control" name="asset_code" id="edit_asset_code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">資産名</label>
                        <input type="text" class="form-control" name="name" id="edit_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">資産タイプ</label>
                        <select class="form-select" name="type" id="edit_type" required>
                            {% for type in asset_types %}
                            <option value="{{ type.name }}">{{ type.jp }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">総数量</label>
                        <input type="number" class="form-control" name="quantity" id="edit_quantity" min="1" required>
                        <div class="form-text">最小数量は1です。数量を増やすと利用可能な単位が追加されます。</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ステータス</label>
                        <select class="form-select" name="status" id="edit_status" required>
                            <option value="Available">利用可能</option>
                            <option value="In Use">使用中</option>
                            <option value="Under maintenance">メンテナンス中</option>
                            <option value="Damaged">損傷</option>
                            <option value="Lost">紛失</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">画像</label>
                        <input type="file" class="form-control" name="image" id="edit_asset_image" accept="image/*">
                        <div class="form-text">JPG, PNG, GIF形式の画像をアップロードできます（最大2MB）</div>
                        <div id="editImagePreview" class="mt-2">
                            <img src="" alt="現在の画像" style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="saveEditAssetBtn">変更を保存</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal cấp phát tài sản cho admin -->
<div class="modal fade" id="assignAssetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">資産を割り当てる: <span id="assign-asset-name"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="assign-asset-id">
        <input type="hidden" id="assign-employee-id">
        <div class="mb-3 position-relative">
          <label for="assign-employee-search" class="form-label">従業員を検索</label>
          <input type="text" class="form-control" id="assign-employee-search" placeholder="名前、コードまたは部署を入力...">
          <div id="assign-employee-suggestions" class="autocomplete-suggestions d-none position-absolute w-100 bg-white border rounded shadow-sm" style="z-index: 1051;"></div>
        </div>
        <div class="mb-3">
          <label for="assign-notes" class="form-label">メモ（任意）</label>
          <textarea class="form-control" id="assign-notes" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" id="confirm-assign-btn">割り当てる</button>
      </div>
    </div>
  </div>
</div>

<!-- Reclaim Asset Modal -->
<div class="modal fade" id="reclaimAssetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">資産を回収</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reclaimForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="assignment_ids" id="reclaim_assignment_ids">
                    <div class="mb-3">
                        <label class="form-label">回収理由</label>
                        <select class="form-select" name="reason" id="reclaim_reason" required>
                            <option value="">理由を選択</option>
                            <option value="Under maintenance">メンテナンス中</option>
                            <option value="Damaged">故障</option>
                            <option value="Not in use / Idle">未使用</option>
                            <option value="Lost">紛失</option>
                            <option value="Other">その他</option>
                        </select>
                    </div>
                    <div class="mb-3" id="otherReasonDiv" style="display: none;">
                        <label class="form-label">その他の理由（指定してください）</label>
                        <input type="text" class="form-control" name="other_reason" id="other_reclaim_reason">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">メモ（任意）</label>
                        <textarea class="form-control" name="notes" id="reclaim_notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" id="confirmReclaimBtn">回収確認</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
.asset-toolbar {
    margin-top: 24px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 12px;
}
.asset-toolbar .form-control,
.asset-toolbar .form-select {
    max-width: 220px;
}
.asset-toolbar button {
    min-width: 160px;
}
@media (max-width: 600px) {
    .asset-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
    }
    .asset-toolbar .form-control,
    .asset-toolbar .form-select,
    .asset-toolbar button {
        max-width: 100%;
        min-width: unset;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Initial load
    loadAssets();

    // Search functionality
    $('#searchInput').on('keyup', function() {
        loadAssets(1); // Go to first page on new search
    });

    // Type filter
    $('#typeFilter').change(function() {
        loadAssets(1); // Go to first page on type filter change
    });

    // Status filter
    $('#statusFilter').change(function() {
        loadAssets(1); // Go to first page on status filter change
    });

    // Handle pagination link clicks (delegated event)
    $(document).on('click', '#paginationLinks a', function(e) {
        e.preventDefault(); // Prevent default link behavior
        var url = $(this).attr('href');
        const urlParams = new URLSearchParams(url.split('?')[1]);
        const page = urlParams.get('page');
        loadAssets(page);
    });

    // Handle select all checkbox
    $('#selectAllAssets').change(function() {
        $('.asset-checkbox').prop('checked', $(this).prop('checked'));
        updateReclaimButton();
    });

    // Handle individual checkboxes
    $(document).on('change', '.asset-checkbox', function() {
        updateReclaimButton();
    });

    // Update reclaim button visibility
    function updateReclaimButton() {
        const checkedCount = $('.asset-checkbox:checked').length;
        $('#reclaimSelectedBtn').toggleClass('d-none', checkedCount === 0);
    }

    // Handle reclaim selected button click
    $('#reclaimSelectedBtn').click(function() {
        const selectedIds = [];
        $('.asset-checkbox:checked').each(function() {
            selectedIds.push($(this).data('assignment-id'));
        });
        
        if (selectedIds.length === 0) {
            showNotification('回収する資産を選択してください', 'warning');
            return;
        }

        $('#reclaim_assignment_ids').val(JSON.stringify(selectedIds));
        $('#reclaimAssetModal').modal('show');
    });
});

function loadAssets(page = 1) {
    var search_query = $('#searchInput').val();
    var type_filter = $('#typeFilter').val();
    var status_filter = $('#statusFilter').val();
    var per_page = 10; // Assuming default per page is 10

    var params = {
        page: page,
        per_page: per_page
    };

    if (search_query) {
        params.search = search_query;
    }
    if (type_filter) {
        params.type = type_filter;
    }
    if (status_filter) {
        params.status = status_filter;
    }

    // Show loading indicator
    var tableBody = $('#assetTableBody');
    tableBody.empty();
    tableBody.append('<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">読み込み中...</span></div><p class="mt-2">資産を読み込んでいます...</p></td></tr>');

    $.ajax({
        url: '/assets', // Use the same route, backend will return JSON for AJAX
        method: 'GET',
        data: params,
        headers: {
            'X-Requested-With': 'XMLHttpRequest' // Identify as AJAX request
        },
        success: function(response) {
            tableBody.empty(); // Clear loading indicator

            if (response.success && response.assets.length > 0) {
                const currentBranch = response.current_branch.toUpperCase(); // Get branch from response
                response.assets.forEach(function(asset) {
                    // Calculate assigned quantity
                    var assigned = asset.quantity - asset.available_quantity;

                    var statusBadge;
                    // Use translated_status instead of manually translating
                    let displayStatus = asset.translated_status || asset.status;
                    
                    if (displayStatus === '利用可能') {
                        statusBadge = '<span class="badge bg-success text-white">' + displayStatus + '</span>';
                    } else if (displayStatus === '使用中') {
                        statusBadge = '<span class="badge bg-primary text-white">' + displayStatus + '</span>';
                    } else if (displayStatus === '破損') {
                        statusBadge = '<span class="badge bg-danger text-white">' + displayStatus + '</span>';
                    } else if (displayStatus === 'メンテナンス中') {
                        statusBadge = '<span class="badge bg-warning text-dark">' + displayStatus + '</span>';
                    } else if (displayStatus === '紛失') {
                        statusBadge = '<span class="badge bg-dark text-white">' + displayStatus + '</span>';
                    } else if (displayStatus === '未使用') {
                        statusBadge = '<span class="badge bg-secondary text-white">' + displayStatus + '</span>';
                    } else {
                        // Fallback for any other status
                        statusBadge = '<span class="badge bg-secondary text-white">' + displayStatus + '</span>';
                    }

                    var row = $('<tr>');
                    row.append($('<td>').text(asset.asset_code));
                    row.append($('<td>').text(asset.name));
                    row.append($('<td>').text(asset.type_jp));
                    row.append($('<td>').text(asset.quantity));
                    row.append($('<td>').text(asset.available_quantity));
                    row.append($('<td>').text(assigned));
                    row.append($('<td>').html(statusBadge));
                    row.append($('<td>').html(`
                        <button class="btn btn-info btn-sm" onclick="viewAsset('${asset.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editAsset('${asset.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAsset('${asset.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="btn btn-success btn-sm assign-asset-btn" data-asset-id="${asset.id}" data-asset-name="${asset.name}" ${displayStatus !== '利用可能' ? 'disabled' : ''}>
                            <i class="fas fa-share-square"></i>
                        </button>
                    `));
                    tableBody.append(row);
                });

                // Thêm dòng trống nếu chưa đủ per_page
                let perPage = response.per_page || 5; // fallback nếu API không trả về
                let emptyRows = perPage - response.assets.length;
                for (let i = 0; i < emptyRows; i++) {
                    let emptyRow = $('<tr>');
                    for (let j = 0; j < 8; j++) { // 8 là số cột
                        emptyRow.append($('<td>&nbsp;</td>'));
                    }
                    tableBody.append(emptyRow);
                }

                // Update pagination links
                updatePaginationLinks(response.total, response.page, response.per_page, response.pages);

            } else if (response.success && response.assets.length === 0) {
                // Show message if no assets found
                tableBody.append('<tr><td colspan="8" class="text-center">選択したフィルターに一致する資産がありません。</td></tr>');
                $('#paginationLinks').empty(); // Clear pagination links if no data
            } else {
                // Show error message from backend
                tableBody.append('<tr><td colspan="8" class="text-center text-danger">資産の読み込み中にエラーが発生しました: ' + (response.message || '不明なエラー') + '</td></tr>');
                $('#paginationLinks').empty(); // Clear pagination links on error
            }
        },
        error: function(xhr, status, error) {
            tableBody.empty();
            tableBody.append('<tr><td colspan="8" class="text-center text-danger">資産の読み込み中にエラーが発生しました。</td></tr>');
            $('#paginationLinks').empty(); // Clear pagination links on error
            console.error("Error fetching assets:", xhr.responseText);
        }
    });
}

function updatePaginationLinks(total, currentPage, perPage, totalPages) {
    var paginationContainer = $('#paginationLinks');
    paginationContainer.empty();

    if (totalPages <= 1) {
        return; // No pagination needed for 1 or fewer pages
    }

    var paginationHtml = '<ul class="pagination justify-content-center">';

    // Previous button (dùng &laquo;)
    paginationHtml += '<li class="' + (currentPage === 1 ? 'disabled' : '') +'"><a class="page-link" href="?page='+ (currentPage - 1) +'&per_page='+ perPage + '" tabIndex="-1">&laquo;</a></li>';

    // Logic giống nhân viên: outer_window=1, inner_window=2
    const inner_window = 2;
    const outer_window = 1;
    let startPage = Math.max(1, currentPage - inner_window);
    let endPage = Math.min(totalPages, currentPage + inner_window);

    // Đảm bảo luôn hiển thị outer_window trang đầu/cuối
    let pages = [];
    for (let i = 1; i <= Math.min(outer_window, totalPages); i++) pages.push(i);
    for (let i = startPage; i <= endPage; i++) if (!pages.includes(i) && i >= 1 && i <= totalPages) pages.push(i);
    for (let i = totalPages - outer_window + 1; i <= totalPages; i++) if (!pages.includes(i) && i >= 1) pages.push(i);
    pages = pages.filter((v, i, a) => a.indexOf(v) === i).sort((a, b) => a - b);

    // Render pages with ellipsis
    let lastPage = 0;
    for (let i = 0; i < pages.length; i++) {
        if (pages[i] - lastPage > 1) {
            paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        paginationHtml += '<li class="page-item' + (pages[i] === currentPage ? ' active' : '') +'"><a class="page-link" href="?page='+ pages[i] +'&per_page='+ perPage +'">'+ pages[i] +'</a></li>';
        lastPage = pages[i];
    }

    // Next button (dùng &raquo;)
    paginationHtml += '<li class="' + (currentPage === totalPages ? 'disabled' : '') +'"><a class="page-link" href="?page='+ (currentPage + 1) +'&per_page='+ perPage +'">&raquo;</a></li>';
    paginationHtml += '</ul>';
    paginationContainer.html(paginationHtml);
}

// Show notification
function showNotification(message, type) {
    var notification = $('<div class="alert alert-' + type + ' position-fixed" role="alert">' + message + '</div>');
    notification.css({
        'top': '20px',
        'right': '20px',
        'z-index': '9999',
        'min-width': '300px',
        'max-width': '500px',
        'box-shadow': '0 4px 12px rgba(0,0,0,0.15)',
        'border-radius': '4px',
        'opacity': '0',
        'transform': 'translateY(-20px)',
        'transition': 'all 0.3s ease-in-out'
    });
    $('body').append(notification);
    setTimeout(function() {
        notification.css({
            'opacity': '1',
            'transform': 'translateY(0)'
        });
    }, 10);
    setTimeout(function() {
        notification.css({
            'opacity': '0',
            'transform': 'translateY(-20px)'
        });
        setTimeout(function() {
            notification.remove();
        }, 300);
    }, 5000);
}

function exportToCSV() {
    // Show processing notification
    var exportBtn = $('button.btn-secondary');
    var originalText = exportBtn.html();
    exportBtn.html('<i class="fas fa-spinner fa-spin"></i> エクスポート中...');
    exportBtn.prop('disabled', true);
    
    $.ajax({
        url: '/api/assets/export-csv',
        method: 'GET',
        xhrFields: {
            responseType: 'blob'
        },
        success: function(data) {
            // Create and download CSV file
            var a = document.createElement('a');
            var url = window.URL.createObjectURL(data);
            a.href = url;
            a.download = 'assets_' + new Date().toISOString().slice(0,10) + '.csv';
            document.body.append(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            // Restore export button
            exportBtn.html(originalText);
            exportBtn.prop('disabled', false);
            
            // Show success notification
            showNotification('CSVファイルが正常にエクスポートされました', 'success');
        },
        error: function() {
            // Restore export button
            exportBtn.html(originalText);
            exportBtn.prop('disabled', false);
            
            // Show error notification
            showNotification('CSVファイルのエクスポート中にエラーが発生しました', 'danger');
        }
    });
}

function submitAssetForm() {
    var formData = new FormData($('#assetForm')[0]);
    
    // Validate quantity
    var quantity = parseInt($('#assetForm input[name="quantity"]').val());
    if (isNaN(quantity) || quantity < 1) {
        showNotification('最小数量は1です', 'warning');
        return;
    }
    
    // Validate image size if present
    const imageFile = $('#assetImage')[0].files[0];
    if (imageFile && imageFile.size > 2 * 1024 * 1024) {
        showNotification('画像サイズは2MB以下にしてください', 'warning');
        return;
    }
    
    // Show processing notification
    $('#addAssetModal .modal-footer').append('<span id="processingMsg" class="text-info ms-2">処理中...</span>');
    
    $.ajax({
        url: '/api/assets',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        },
        success: function(response) {
            $('#processingMsg').remove();
            
            if (response.success) {
                // Hide modal
                $('#addAssetModal').modal('hide');
                // Reset form
                $('#assetForm')[0].reset();
                // Show success notification
                showNotification('資産が正常に追加されました', 'success');
                // Update asset list instead of reloading page
                loadAssets();
            } else {
                // Show error notification
                showNotification(response.message, 'danger');
            }
        },
        error: function(xhr) {
            $('#processingMsg').remove();
            if (xhr.status === 401) {
                // Session expired, redirect to login
                window.location.href = '/login';
            } else {
                showNotification(xhr.responseJSON?.message || 'Unknown error', 'danger');
            }
        }
    });
}

function viewAsset(id) {
    window.currentAssetId = id;
    // Show modal with loading state
    $('#assetDetailsModal').modal('show');
    $('#assetDetailsLoading').removeClass('d-none');
    $('#assetDetailsContent').addClass('d-none');
    
    // Fetch asset details
    $.ajax({
        url: '/api/assets/' + id,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                // Hide loading, show content
                $('#assetDetailsLoading').addClass('d-none');
                $('#assetDetailsContent').removeClass('d-none');
                
                // Fill in asset details
                var asset = response.asset;
                $('#detail-asset-code').text(asset.asset_code);
                $('#detail-name').text(asset.name);
                $('#detail-type').text(asset.type_jp);
                $('#detail-quantity').text(asset.quantity);
                $('#detail-available').text(asset.available_quantity);
                $('#detail-status').text(asset.translated_status || asset.status);
                $('#detail-branch').text(asset.branch === 'japan' ? '日本' : (asset.branch === 'vietnam' ? 'ベトナム' : asset.branch));
                
                // Debug: log employees
                console.log('[DEBUG] Employees from API:', response.employees);
                var employees = response.employees;
                var tableBody = $('#assignmentsTableBody');
                tableBody.empty();
                
                if (employees && employees.length > 0) {
                    $('#assignmentsTable').removeClass('d-none').show();
                    $('#noAssignmentsMsg').addClass('d-none').hide();
                    employees.forEach(function(emp) {
                        tableBody.append(`
                            <tr>
                                <td>${emp.employee_code}</td>
                                <td>${emp.name}</td>
                                <td>${emp.department}</td>
                                <td>${emp.email}</td>
                                <td>${emp.branch === 'japan' ? '日本' : (emp.branch === 'vietnam' ? 'ベトナム' : emp.branch)}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm reclaim-asset-btn" 
                                            data-assignment-id="${emp.assignment_id}"
                                            data-asset-name="${asset.name}"
                                            data-employee-name="${emp.name}">
                                        <i class="fas fa-undo"></i> 回収
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                } else {
                    $('#assignmentsTable').addClass('d-none').hide();
                    $('#noAssignmentsMsg').removeClass('d-none').show();
                }
            } else {
                showNotification(response.message, 'danger');
                $('#assetDetailsModal').modal('hide');
            }
        },
        error: function(xhr, status, error) {
            showNotification('資産詳細の取得エラーが発生しました', 'danger');
            $('#assetDetailsModal').modal('hide');
        }
    });
}

function editAsset(id) {
    // Show modal with loading state
    $('#editAssetModal').modal('show');
    $('#editAssetLoading').removeClass('d-none');
    $('#editAssetForm').addClass('d-none');
    
    // Fetch asset details to populate the form
    $.ajax({
        url: '/api/assets/' + id,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                // Hide loading, show form
                $('#editAssetLoading').addClass('d-none');
                $('#editAssetForm').removeClass('d-none');
                
                // Fill in asset details
                var asset = response.asset;
                $('#edit_asset_id').val(asset.id);
                $('#edit_asset_code').val(asset.asset_code);
                $('#edit_name').val(asset.name);
                $('#edit_type').val(asset.type);
                $('#edit_quantity').val(asset.quantity);
                $('#edit_status').val(asset.status);
                
                // Set current image if exists
                if (asset.image_url) {
                    $('#editImagePreview').show().find('img').attr('src', asset.image_url);
                } else {
                    $('#editImagePreview').hide();
                }
                
                // Check if asset is already assigned to any employee
                if (response.employees && response.employees.length > 0) {
                    // Disable reducing quantity below assigned count
                    const assignedCount = asset.quantity - asset.available_quantity;
                    $('#edit_quantity').attr('min', assignedCount);
                    
                    if (assignedCount > 0) {
                        $('.form-text').text(`この資産は ${assignedCount} 単位が従業員に割り当てられています。最小数量は ${assignedCount} です。`);
                    }
                }
                
                // Set up save button handler
                $('#saveEditAssetBtn').off('click').on('click', function() {
                    saveEditedAsset(id);
                });
            } else {
                showNotification(response.message, 'danger');
                $('#editAssetModal').modal('hide');
            }
        },
        error: function() {
            showNotification('資産詳細の取得エラーが発生しました', 'danger');
            $('#editAssetModal').modal('hide');
        }
    });
}

function saveEditedAsset(id) {
    // Validate form
    const form = document.getElementById('editAssetForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Get form data
    const formData = new FormData(form);
    
    // Validate image size if present
    const imageFile = $('#edit_asset_image')[0].files[0];
    if (imageFile && imageFile.size > 2 * 1024 * 1024) {
        showNotification('画像サイズは2MB以下にしてください', 'warning');
        return;
    }
    
    // Show processing notification
    $('#editAssetModal .modal-footer').append('<span id="processingEditMsg" class="text-info ms-2">処理中...</span>');
    $('#saveEditAssetBtn').prop('disabled', true);
    
    $.ajax({
        url: '/api/assets/' + id,
        method: 'PUT',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        },
        success: function(response) {
            $('#processingEditMsg').remove();
            $('#saveEditAssetBtn').prop('disabled', false);
            
            if (response.success) {
                // Hide modal
                $('#editAssetModal').modal('hide');
                
                // Show success notification
                showNotification(response.message || '資産更新成功', 'success');
                
                // Update asset list instead of reloading page
                loadAssets();
            } else {
                // Show error notification
                showNotification(response.message, 'danger');
            }
        },
        error: function(xhr) {
            $('#processingEditMsg').remove();
            $('#saveEditAssetBtn').prop('disabled', false);
            showNotification(xhr.responseText, 'danger');
        }
    });
}

function deleteAsset(id) {
    // First check if asset is currently assigned to any employee
    $.ajax({
        url: '/api/assets/' + id,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                const asset = response.asset;
                const employees = response.employees;
                
                const assignedCount = asset.quantity - asset.available_quantity;
                
                // If asset is assigned to employees, show warning
                if (assignedCount > 0 && employees && employees.length > 0) {
                    let employeeNames = employees.map(emp => emp.name).join(", ");
                    if (employees.length > 3) {
                        employeeNames = employees.slice(0, 3).map(emp => emp.name).join(", ") + 
                            ` and ${employees.length - 3} more`;
                    }
                    
                    const warningMessage = `この資産は削除できません。${assignedCount} 単位が現在 ${employeeNames} に割り当てられているためです。削除する前にすべての資産を回収してください。`;
                    showNotification(warningMessage, 'warning');
                    return;
                }
                
                // If asset is not assigned, confirm deletion
                if (confirm('この資産を削除してもよろしいですか？')) {
                    // Store a reference to the row being deleted
                    var rowElement = $(`button[onclick="deleteAsset('${id}')"]`).closest('tr');
                    
                    // Show loading effect for the row being deleted
                    rowElement.css({
                        'opacity': '0.5',
                        'transition': 'all 0.3s ease'
                    });
                    
                    // Delete asset
                    $.ajax({
                        url: '/api/assets/' + id,
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                        },
                        success: function(response) {
                            if (response.success) {
                                // Show success notification
                                showNotification('資産削除成功!', 'success');
                                
                                // Add visual deletion effect
                                rowElement.css({
                                    'transform': 'translateX(100%)',
                                    'opacity': '0'
                                });
                                
                                // Actually remove the row from DOM after animation completes
                                setTimeout(function() {
                                    // Explicitly remove the row from DOM
                                    rowElement.remove();
                                    
                                    // Check if table is now empty
                                    if ($('table tbody tr').length === 0) {
                                        showNotification('すべての資産が削除されました', 'info');
                                    }
                                }, 300);
                            } else {
                                // Restore row state
                                rowElement.css({
                                    'opacity': '1'
                                });
                                
                                // Show error notification
                                showNotification(response.message, 'danger');
                            }
                        },
                        error: function(xhr, status, error) {
                            // Restore row state
                            rowElement.css({
                                'opacity': '1'
                            });
                            
                            console.error("XHR Status:", status);
                            console.error("Error:", error);
                            console.error("Response:", xhr.responseText);
                            showNotification('資産削除エラーが発生しました: ' + (xhr.responseText || error), 'danger');
                        }
                    });
                }
            } else {
                showNotification(response.message, 'danger');
            }
        },
        error: function() {
            showNotification('資産ステータスの確認エラーが発生しました', 'danger');
        }
    });
}

var allEmployees = [];
$(document).on('click', '.assign-asset-btn', function() {
    var assetId = $(this).data('asset-id');
    var assetName = $(this).data('asset-name');
    $('#assign-asset-id').val(assetId);
    $('#assign-asset-name').text(assetName);
    $('#assign-notes').val('');
    $('#assign-employee-search').val('');
    $('#assign-employee-id').val('');
    $('#assign-employee-suggestions').empty().addClass('d-none');
    // Lấy danh sách nhân viên
    $.get('/api/employees/active', function(res) {
        console.log('API /api/employees/active trả về:', res); // Debug
        if (res.success && res.employees.length > 0) {
            allEmployees = res.employees;
        } else {
            allEmployees = [];
        }
        $('#assignAssetModal').modal('show');
    });
});

// Autocomplete nhân viên
$('#assign-employee-search').on('input', function() {
    $('#assign-employee-id').val(''); // reset id khi thay đổi input
    var val = $(this).val().toLowerCase();
    var suggestions = '';
    console.log('allEmployees:', allEmployees); // debug
    if (val && allEmployees.length > 0) {
        var filtered = allEmployees.filter(function(emp) {
            return (emp.name && emp.name.toLowerCase().includes(val)) ||
                   (emp.employee_code && emp.employee_code.toLowerCase().includes(val)) ||
                   (emp.department && emp.department.toLowerCase().includes(val));
        });
        console.log('filtered:', filtered); // debug
        filtered.slice(0, 10).forEach(function(emp) {
            suggestions += '<div class="autocomplete-suggestion px-2 py-1" data-id="' + emp.id + '" data-name="' + emp.name + '">' + emp.employee_code + ' - ' + emp.name + ' (' + emp.department + ')</div>';
        });
    }
    var sugDiv = $('#assign-employee-suggestions');
    if (suggestions) {
        sugDiv.html(suggestions).removeClass('d-none');
    } else {
        sugDiv.html('').addClass('d-none');
    }
});

// Chọn nhân viên từ gợi ý
$(document).on('click', '.autocomplete-suggestion', function() {
    var id = $(this).data('id');
    var name = $(this).data('name');
    $('#assign-employee-search').val(name);
    $('#assign-employee-id').val(id);
    $('#assign-employee-suggestions').addClass('d-none');
});

// Ẩn gợi ý khi click ngoài
$(document).on('click', function(e) {
    if (!$(e.target).closest('#assign-employee-search, #assign-employee-suggestions').length) {
        $('#assign-employee-suggestions').addClass('d-none');
    }
});

$('#confirm-assign-btn').on('click', function() {
    var assetId = $('#assign-asset-id').val();
    var employeeId = $('#assign-employee-id').val();
    var notes = $('#assign-notes').val();
    var employeeName = $('#assign-employee-search').val();
    if (!employeeId || !employeeName) {
        showNotification('候補リストから従業員を選択してください', 'warning');
        return;
    }
    $.ajax({
        url: '/api/asset-assignments/admin-assign',
        method: 'POST',
        data: { asset_id: assetId, employee_id: employeeId, notes: notes },
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        },
        success: function(res) {
            if (res.success) {
                showNotification('資産割り当て成功', 'success');
                $('#assignAssetModal').modal('hide');
                setTimeout(function() { location.reload(); }, 800);
            } else {
                showNotification(res.message || '割り当てに失敗しました', 'danger');
            }
        },
        error: function() {
            showNotification('資産割り当てエラーが発生しました', 'danger');
        }
    });
});

// Handle Reclaim Asset button click
$(document).on('click', '#reclaimAssetBtn', function() {
    // Get the assignment_id from the displayed details. This requires storing it when viewing asset details.
    // For simplicity now, we'll assume only one assignment is shown or we pick the first one.
    // A better implementation would list all assignments for the asset and allow selecting which one to reclaim.
    // As per the current structure, the assignmentsTableBody is populated with assigned employees.
    // We need to get the assignment_id from somewhere. Let's assume the viewAsset API also returns assignment IDs.
    
    // TEMPORARY: For now, let's just show the modal. We'll need to pass the assignment_id properly later.
    $('#reclaimAssetModal').modal('show');
});

// Handle change in reclaim reason dropdown
$('#reclaim_reason').change(function() {
    if ($(this).val() === 'Other') {
        $('#otherReasonDiv').show();
        $('#other_reclaim_reason').prop('required', true);
    } else {
        $('#otherReasonDiv').hide();
        $('#other_reclaim_reason').prop('required', false);
        $('#other_reclaim_reason').val('');
    }
});

// Handle confirm reclaim button click
$('#confirmReclaimBtn').on('click', function() {
    if (!validateReclaimForm()) {
        return;
    }
    let assignmentIds = [];
    try {
        assignmentIds = JSON.parse($('#reclaim_assignment_ids').val() || '[]');
    } catch (e) {
        assignmentIds = [];
    }
    let reason = $('#reclaim_reason').val();
    const notes = $('#reclaim_notes').val();
    if (reason === 'Other') {
        reason = $('#other_reclaim_reason').val();
    }
    $('#reclaimAssetModal .modal-footer').append('<span id="processingReclaimMsg" class="text-info ms-2">処理中...</span>');
    $('#confirmReclaimBtn').prop('disabled', true);
    logAction('asset_reclaim_start', {
        assignment_ids: assignmentIds,
        reason: reason
    });
    $.ajax({
        url: '/api/asset-assignments/bulk-reclaim',
        method: 'POST',
        data: {
            assignment_ids: JSON.stringify(assignmentIds),
            reason: reason,
            notes: notes
        },
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        },
        success: function(response) {
            $('#processingReclaimMsg').remove();
            $('#confirmReclaimBtn').prop('disabled', false);
            if (response.success) {
                showNotification(response.message || '資産の回収が完了しました', 'success');
                $('#reclaimAssetModal').modal('hide');
                logAction('asset_reclaim_success', {
                    assignment_ids: assignmentIds,
                    reason: reason
                });
                // Cập nhật lại modal chi tiết tài sản nếu đang mở
                if (window.currentAssetId) {
                    viewAsset(window.currentAssetId);
                }
                // Cập nhật lại danh sách tài sản bên ngoài
                loadAssets();
            } else {
                showNotification(response.message || '資産の回収中にエラーが発生しました', 'danger');
                logAction('asset_reclaim_error', {
                    assignment_ids: assignmentIds,
                    error: response.message
                });
            }
        },
        error: function(xhr) {
            $('#processingReclaimMsg').remove();
            $('#confirmReclaimBtn').prop('disabled', false);
            logAction('asset_reclaim_error', {
                assignment_ids: assignmentIds,
                error: xhr.responseText
            });
            showNotification('資産の回収中にエラーが発生しました', 'danger');
        }
    });
});

// Add form validation function
function validateReclaimForm() {
    const form = document.getElementById('reclaimForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return false;
    }
    const reason = $('#reclaim_reason').val();
    if (reason === 'Other' && !$('#other_reclaim_reason').val()) {
        showNotification('その他の理由を入力してください', 'warning');
        return false;
    }
    return confirm('選択した資産を回収してもよろしいですか？');
}

// Add logging function
function logAction(action, data) {
    $.ajax({
        url: '/api/logs',
        method: 'POST',
        data: {
            action: action,
            data: JSON.stringify(data)
        },
        headers: {
            'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
        }
    });
}

// Handle click on individual reclaim button (chi tiết tài sản)
$(document).on('click', '.reclaim-asset-btn', function() {
    const assignmentId = $(this).data('assignment-id');
    // Đảm bảo luôn set đúng assignment_id vào hidden input dưới dạng mảng JSON
    $('#reclaim_assignment_ids').val(JSON.stringify([assignmentId]));
    // Reset form
    $('#reclaimForm')[0].reset();
    $('#otherReasonDiv').hide();
    $('#other_reclaim_reason').prop('required', false);
    // Show modal
    $('#reclaimAssetModal').modal('show');
});

// Add image preview functionality for new asset
$('#assetImage').change(function() {
    const file = this.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) { // 2MB limit
            showNotification('画像サイズは2MB以下にしてください', 'warning');
            this.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#imagePreview').show().find('img').attr('src', e.target.result);
        }
        reader.readAsDataURL(file);
    } else {
        $('#imagePreview').hide();
    }
});

// Add image preview functionality for edit asset
$('#edit_asset_image').change(function() {
    const file = this.files[0];
    if (file) {
        if (file.size > 2 * 1024 * 1024) { // 2MB limit
            showNotification('画像サイズは2MB以下にしてください', 'warning');
            this.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#editImagePreview').show().find('img').attr('src', e.target.result);
        }
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %} 